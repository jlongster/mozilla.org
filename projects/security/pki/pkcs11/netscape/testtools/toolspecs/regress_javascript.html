<?php

$html_title = 'Regress Modifications: Support Javascript-Enabled Display';

$menu = array(
    'id' => 'default',
);

require_once "{$config['file_root']}/includes/header.inc.php"

?>

<center>
<h2>Regress Modifications: Support Javascript-Enabled Display</h2>
<i><FONT SIZE="-1">

Newsgroup: 
<A HREF="news://news.mozilla.org/mozilla.dev.tech.crypto">mozilla.dev.tech.crypto</A><BR>

Technical contact: 
<A HREF="mailto:relyea@netscape.com?subject=PKCS #11 Netscape PK11 Test Suite Feedback">Bob Relyea</A><BR>

Yell at the manager: 
<A HREF="mailto:lord@netscape.com?subject=PKCS #11 Netscape PK11 Test Suite Feedback">Bob Lord</A></FONT></i>
</center>



<FONT COLOR="#000000">(Status: Draft 1.01)</FONT>

<P><B>Overview</FONT></B>

<P><FONT COLOR="#000000">The HTML output produced by Regress is currently
in tabular format.&nbsp; This format has the following disadvantages:</FONT>
<UL>
<LI>
<FONT COLOR="#000000">When entries get above 8000, the Browser will often
crash due to difficulties in drawing the table for such a large number
of entries.</FONT></LI>

<LI>
<FONT COLOR="#000000">When there are too many entries, it is difficult
to go to a specific test and look at the results.</FONT></LI>

<LI>
<FONT COLOR="#000000">There is no mechanism in which to look at only fail
entries or only pass entries given a page containing a mix of both types</FONT></LI>
</UL>
<FONT COLOR="#000000">The solution is to create an additional interface
to the Regress output display -- Implement&nbsp; an easy to use interface
that uses JavaScript to dynamically page through the data.</FONT>

<P><B>Changes to regress usage</FONT></B>

<P><FONT COLOR="#000000">Regress may be set to output its test result data
in either the old Table format or the new JavaScript format by specifying
at the command line:</FONT>

<P><FONT COLOR="#000000">&nbsp;&nbsp;&nbsp; regress specfile=[specfilename]
style=table&nbsp;&nbsp;&nbsp; // for the old table format</FONT>
<BR><FONT COLOR="#000000">or</FONT>
<BR><FONT COLOR="#000000">&nbsp;&nbsp;&nbsp;&nbsp; regress specfile=[specfilename]
style=javascript&nbsp;&nbsp;&nbsp; // for the new javascript format</FONT>

<P><FONT COLOR="#000000">If style is not specified at the command line,
then the default is the new javascript format</FONT>
<BR><FONT COLOR="#000000">Alternatively, Regress users can specify in their
regress specfile under [General] header, an additional field</FONT>

<P><TT><FONT COLOR="#000000"><B>style</B>=[table|javascript]</FONT></TT>

<P><FONT COLOR="#000000">NOTE: The value set at the command line will overwrite
any style options set in the specfile.</FONT>

<P>Here is an example of the JavaScript Interface.

<P><B>Notes about the Code</FONT></B>
<BR>(You should read the following only if you intend to make changes to
the JavaScript interface)

<P>The heart of the Javascript generation code is a collection of functions
which I have defined in genjs.c and genjs.h.&nbsp;&nbsp;&nbsp; These two
files are built by a Perl script makeGenJS.pl.&nbsp;&nbsp;&nbsp; The basic
idea is that the makeGenJS.pl script takes a Javascript template genjs_template.html
and extracts portions of the code to generate genjs.c and genjs.h.&nbsp;&nbsp;&nbsp;&nbsp;
Using this methodology, one can easily make changes to the JavaScript template
in terms of code or display layout modifications without ever looking at
the C code.&nbsp;&nbsp; Below is a list of functions created in <TT>genjs.c</TT>
by <TT>makeGenJS.pl</TT>, and a brief description of their purpose/behavior:
<BR>&nbsp;
<TABLE BORDER COLS=2 WIDTH="98%" >
<TR>
<TD><B>Function Name</B></TD>

<TD><B>Description</B></TD>
</TR>

<TR>
<TD><TT>genJS_Top(PRFileDesc*)</TT></TD>

<TD>Every output page generated by Regress will have a general static region
(actually 2) of JavaScript code which does not change depending on the
test run.&nbsp; This function prints out the static JavaScript portion
up to the data insertion section (marked by "<TT>//data init"</TT>)&nbsp;
(see below for template layout)</TD>
</TR>

<TR>
<TD><TT>genJS_Bottom(PRFileDesc*)</TT></TD>

<TD>This function outputs the static Javascript code from after the data
initialization region to the very end of the template.</TD>
</TR>

<TR>
<TD><TT>genJS_Header(PRFileDesc*, char*)</TT></TD>

<TD>Generates the appropriate header &lt;TITLE>[name of page]&lt;/TITLE>
for the test being run.&nbsp;&nbsp; The second argument is the string containing
the page title&nbsp;</TD>
</TR>

<TR>
<TD><TT>genJS_InsertVars(....)</TT></TD>

<TD>Inserts variable initialization statements for JavaScript variables:&nbsp;
<BR>mutdesc, mutversion, rundate and platform.&nbsp;&nbsp; Takes as argument
the values these four variables are to be initialized to, and outputs the
following text to the output file:&nbsp;

<P><TT>var mutdesc = &lt;mutdesc value>;</TT>&nbsp;
<BR><TT>var mutversion = &lt;mutversion value>;</TT>&nbsp;
<BR><TT>var platform = &lt;platform value>;</TT>&nbsp;
<BR><TT>var rundate = &lt;rundate value>;</TT>&nbsp;
<BR>&nbsp;</TD>
</TR>

<TR>
<TD><TT>genJS_SummaryVars(...)</TT></TD>

<TD>The same idea as with InsertVars, but outputs initialization statements
for Summary Table related variables: numPass, numFail, numKnownFail, and
numMalFormed.</TD>
</TR>

<TR>
<TD><TT>genJS_DeclareData(PRFileDesc*, char* length)</TT></TD>

<TD>Outputs the Data array declaration string:&nbsp;
<BR><TT>var Data = new Array(&lt;length>);</TT></TD>
</TR>

<TR>
<TD><TT>genJS_InsertData(...)</TT></TD>

<TD>Outputs the initialization expressions for each Data element.&nbsp;
(This function is called for each test combination).&nbsp;
<BR>Hence will produce the following for [Test-n]&nbsp;

<P><TT>Data[&lt;n>] = new TestData( &lt; arguments that initializes test
object n >);</TT></TD>
</TR>

<TR>
<TD><TT>genJS_PutColor(char* string, char* colorCode)</TT></TD>

<TD>A simple HTML utility that wraps a &lt;FONT COLOR="&lt;colorCode">
&lt;/FONT> around the given string.&nbsp;&nbsp; Does the same thing as
GENHTML_PutColor, but produces escaped quotes in the output.&nbsp;&nbsp;
For example: genJS_PutColor will generate&nbsp;

<P>&lt;FONT COLOR=\"&lt;colorCode>\">....&lt;/FONT>&nbsp;

<P>whereas GENHTML_PutColor will generate&nbsp;

<P>&lt;FONT COLOR="&lt;colorCode>"...&lt;/FONT>&nbsp;

<P>The escaped quotes around &lt;colorCode> is necessary because what is
generated by genJS_PutColor must be reinterpreted by JavaScript (in essence
we are outputting code, so quotes in strings must be escaped.)</TD>
</TR>
</TABLE>
&nbsp;

<P><B>How the Java Script template is organized</FONT></B>

<P>&lt;HTML>
<BR>&lt;HEAD>....
<BR>&lt;SCRIPT language=JavaScript>&nbsp;&nbsp;&nbsp; &lt;==== genJS_Header
generates this portion
<BR>....

<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&lt;==== All the code up to this point goes into genJS_Top
<BR>//data init&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&lt;==== genJS_InsertVars, genJS_SummaryVar, genJS_DeclareData, and
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
genJS_InsertData are called here to initialize Java script variables

<P>...
<BR>&lt;/SCRIPT>
<BR>&lt;/HTML>

<P><B>JavaScript Data Organization:</FONT></B>

<P>Basically, in place of Table elements, all the data collected by Regress
for each test is turned into a Data[] array element initialization statement.&nbsp;&nbsp;&nbsp;&nbsp;
Each Data[] element current contains the following Fields:

<P>testno&nbsp;&nbsp; // a number representing the 'n' in [Test-n].
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // The
testno is not guaranteed to have one to one correspondence with
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// Data[]'s index.
<BR>passOrFail // A flag to indicate pass or fail status of a test&nbsp;
1 is a Pass, 0 is a Fail

<P>// The following fields are simply strings that correspond to the original
<BR>// table columns which they belonged in
<BR>filename
<BR>description
<BR>starttime
<BR>endtime
<BR>result

<P>Each Data[] element is initialized in the following manner:

<P>Data[&lt;n>] = new TestData(&lt;testno>, &lt;passOrFail>, "&lt;filename>",
"&lt;description>", "&lt;starttime>", "&lt;endtime>", "&lt;result>")

<P>Each test has its own Data[] initialization statement.

<P><B>Making Changes:</B>

<P><FONT COLOR="#000000">When making changes to the JavaScript template
the following guidelines should be followed</FONT>
<UL>
<LI>
<FONT COLOR="#000000">Avoid escaped characters when possible.&nbsp;&nbsp;
Although I have programmed into the Perl script to check for escaped characters
and replace them with escaped escaped characters (because we are generating
code that generate code), there may be holes which I have not fully checked
for.&nbsp;&nbsp;&nbsp; If you require to print a "\n" (new line) character
use the javascript function <TT>writeln</TT> instead.</FONT></LI>

<LI>
<FONT COLOR="#000000">Use the variables defined for summary and general
variables (as described above for genJS_SummaryVars and genJS_InsertVars)
do not invent new ones.</FONT></LI>
</UL>
<B>Where to Make Changes in the JavaScript template</B>

<P><FONT COLOR="#000000">The following is a brief description of JavaScript
functions that generate HTML, these functions can be modified in order
to change the appearance of the output interface.</FONT>
<BR>&nbsp;
<TABLE BORDER COLS=2 WIDTH="100%" >
<TR>
<TD><B><FONT COLOR="#000000">JavaScript Function</FONT></B></TD>

<TD><B>Description</B></TD>
</TR>

<TR>
<TD><FONT COLOR="#000000">generateTable()</FONT></TD>

<TD><FONT COLOR="#000000">contains the code that produces the HTML (Table)
in the middle frame</FONT></TD>
</TR>

<TR>
<TD><FONT COLOR="#000000">createControlPanel()</FONT></TD>

<TD><FONT COLOR="#000000">contains the code that produces the interface
in the bottom frame.</FONT></TD>
</TR>

<TR>
<TD><FONT COLOR="#000000">createHeader()</FONT></TD>

<TD><FONT COLOR="#000000">generates the HTML in the first frame. Which
has the module under test description and the Summary data.</FONT></TD>
</TR>
</TABLE>
<FONT COLOR="#000000">&nbsp;</FONT>
<BR><B>A Note on Building genjs.c and genjs.h</B>

<P><FONT COLOR="#000000">After making modifications to either the genjs_template.html,
or makeGenJS.pl (the Perl script that generates the C code).&nbsp; Invoke</FONT>
<BR><FONT COLOR="#000000">makeGenJS.pl (make sure you are using at least
version 4 Perl).&nbsp;&nbsp;&nbsp; This will rebuild the above genjs source
files.&nbsp;&nbsp; Then, simply follow general Regress building instructions.</FONT>


<?
require_once "{$config['file_root']}/includes/footer.inc.php"
?>
